<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜é¦¬äºŒæ¨“ç©åˆ†å…Œæ›</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 1400px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        /* é€™è£¡æ˜¯æ–°å¢çš„é¡è‰²è¨­å®š */
        #activeUsers,
        #activeUsers + .stat-label {
            color: #ffd900; /* ç‹è€…ç”¨æˆ¶ */
        }

        #activeUser4,
        #activeUser4 + .stat-label {
            color: #9035F8; /* é‘½çŸ³ç”¨æˆ¶ */
        }

        #activeUser3,
        #activeUser3 + .stat-label {
            color: #75c8ff; /* é‰‘é‡‘ç”¨æˆ¶ */
        }

        #activeUser2,
        #activeUser2 + .stat-label {
            color: #ff8904; /* é»ƒé‡‘ç”¨æˆ¶ */
        }

        #activeUser1,
        #activeUser1 + .stat-label {
            color: #5fecfc; /* ç™½éŠ€ç”¨æˆ¶ */
        }

        #activeUser0,
        #activeUser0 + .stat-label {
            color: brown; /* é’éŠ…ç”¨æˆ¶ */
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 30px;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .card-header i {
            font-size: 24px;
            margin-right: 15px;
            color: #2575fc;
        }
        
        .card-header h2 {
            color: #333;
            font-size: 1.8rem;
        }
        
        .login-section {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .login-card {
            flex: 1;
            min-width: 300px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            border-color: #2575fc;
            box-shadow: 0 0 0 3px rgba(37, 117, 252, 0.1);
            outline: none;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 25px;
            background: #2575fc;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .btn:hover {
            background: #1a68e8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .btn-success {
            background: #2ecc71;
        }
        
        .btn-success:hover {
            background: #27ae60;
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-warning {
            background: #f39c12;
        }
        
        .btn-warning:hover {
            background: #d35400;
        }
        
        .btn-info {
            background: #3498db;
        }
        
        .btn-info:hover {
            background: #2980b9;
        }
        
        .btn-secondary {
            background: #95a5a6;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .barcode-scan {
            text-align: center;
            padding: 20px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .barcode-scan:hover {
            border-color: #2575fc;
            background: rgba(37, 117, 252, 0.05);
        }
        
        .barcode-scan i {
            font-size: 48px;
            color: #2575fc;
            margin-bottom: 15px;
        }
        
        .barcode-scan p {
            color: #666;
            font-size: 16px;
        }
        
        .dashboard {
            display: none;
        }
        
        .user-info {
            background: linear-gradient(135deg, #2575fc 0%, #6a11cb 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-info h3 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .points {
            font-size: 2.5rem;
            font-weight: bold;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            border-bottom: 3px solid #2575fc;
            color: #2575fc;
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .prizes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .prize-card {
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .prize-card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-5px);
        }
        
        .prize-image {
            width: 100%;
            height: 150px;
            background: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: #2575fc;
        }
        
        .prize-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .prize-points {
            color: #2575fc;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .admin-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .admin-controls .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .users-table, .history-table, .prizes-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .users-table th, .users-table td,
        .history-table th, .history-table td,
        .prizes-table th, .prizes-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .users-table th, .history-table th, .prizes-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }
        
        .users-table tr:hover, .history-table tr:hover, .prizes-table tr:hover {
            background: #f8f9fa;
        }
        
        .action-btn {
            padding: 6px 12px;
            margin-right: 5px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .action-btn:hover {
            opacity: 0.9;
        }
        
        .logout-btn {
            background: #e74c3c;
            margin-top: 20px;
        }
        
        .logout-btn:hover {
            background: #c0392b;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #2ecc71;
            color: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-header h3 {
            color: #333;
            font-size: 1.5rem;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #777;
        }
        
        .close-btn:hover {
            color: #333;
        }
        
        .history-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-points {
            font-weight: bold;
        }
        
        .points-positive {
            color: #2ecc71;
        }
        
        .points-negative {
            color: #e74c3c;
        }
        
        .barcode-container {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .barcode-container canvas {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        
        .barcode-placeholder {
            color: #666;
            font-style: italic;
            padding: 20px;
        }
        
        .scan-area {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }
        
        #scanner-container {
            width: 100%;
            height: 300px;
            background: #f5f5f5;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        
        #scanner-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .scan-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }
        
        .scan-line {
            width: 80%;
            height: 2px;
            background: #2575fc;
            position: relative;
            animation: scan 2s infinite linear;
        }
        
        @keyframes scan {
            0% { top: -50%; }
            100% { top: 150%; }
        }
        
        .scan-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .user-barcode {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 15px 0;
        }
        
        .login-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .login-option-btn {
            flex: 1;
            padding: 10px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        
        .login-option-btn.active {
            background: #2575fc;
            color: white;
            border-color: #2575fc;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-box input {
            flex: 1;
        }
        
        .data-management {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .data-management .btn {
            flex: 1;
            min-width: 150px;
        }
        
        .user-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #2575fc;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .reason-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .reason-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .user-tier {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .tier-king {
            background-color: #ffd900;
            color: #000;
        }
        
        .tier-diamond {
            background-color: #9035F8;
            color: white;
        }
        
        .tier-platinum {
            background-color: #75c8ff;
            color: #000;
        }
        
        .tier-gold {
            background-color: #ff8904;
            color: white;
        }
        
        .tier-silver {
            background-color: #5fecfc;
            color: #000;
        }
        
        .tier-bronze {
            background-color: brown;
            color: white;
        }
        
        @media (max-width: 768px) {
            .login-section {
                flex-direction: column;
            }
            
            .admin-controls {
                flex-direction: column;
            }
            
            .prizes-grid {
                grid-template-columns: 1fr;
            }
            
            .users-table, .history-table, .prizes-table {
                display: block;
                overflow-x: auto;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1;
                min-width: 120px;
                text-align: center;
            }
            
            .login-options {
                flex-direction: column;
            }
            
            .data-management {
                flex-direction: column;
            }
            
            .user-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æ˜é¦¬äºŒæ¨“å®¿èˆç©åˆ†å…Œæ›</h1>
            <p>æ˜æ„›é¦¬éå±±ä¸­å­¸äºŒæ¨“å®¿èˆå°ˆç”¨</p>
        </div>
        
        <!-- ç™»é™¸å€åŸŸ -->
        <div class="login-section" id="loginSection">
            <!-- ç”¨æˆ¶ç™»éŒ„ -->
            <div class="card login-card">
                <div class="card-header">
                    <i class="fas fa-user"></i>
                    <h2>ç”¨æˆ¶ç™»éŒ„</h2>
                </div>
                
                <div class="login-options">
                    <div class="login-option-btn active" id="userCodeLoginBtn">ç”¨æˆ¶ç·¨è™Ÿç™»é™¸</div>
                    <div class="login-option-btn" id="userBarcodeLoginBtn">QRcodeç™»é™¸</div>
                </div>
                
                <div id="userCodeLoginForm">
                    <div class="form-group">
                        <label for="userIdInput">ç”¨æˆ¶ç·¨è™Ÿ</label>
                        <input type="text" id="userIdInput" class="form-control" placeholder="è¼¸å…¥ç”¨æˆ¶ç·¨è™Ÿ">
                    </div>
                    <button class="btn btn-block" id="userLoginBtn">ç”¨æˆ¶ç™»éŒ„</button>
                </div>
                
                <div id="userBarcodeLoginForm" style="display: none;">
                    <div class="barcode-scan" id="userBarcodeScan">
                        <i class="fas fa-barcode"></i>
                        <p>é»æ“Šæ­¤è™•æƒæQRcode</p>
                        <p class="small">ä¸¦å°‡QRcodeå°æº–æ”åƒé ­</p>
                    </div>
                </div>
                
                <div class="user-info" style="display: none;" id="userInfo">
                    <div>
                        <h3 id="userName">å¼ ä¸‰</h3>
                        <p>ç”¨æˆ·ç¼–å·: <span id="userId">U1001</span></p>
                    </div>
                    <div class="points" id="userPoints">1500</div>
                </div>
            </div>
            
            <!-- ç®¡ç†å‘˜ç™»å½• -->
            <div class="card login-card">
                <div class="card-header">
                    <i class="fas fa-user-shield"></i>
                    <h2>ç®¡ç†å‘˜ç™»å½•</h2>
                </div>
                
                <div class="login-options">
                    <div class="login-option-btn active" id="adminCodeLoginBtn">ç®¡ç†å“¡ç·¨è™Ÿç™»é™¸</div>
                    <div class="login-option-btn" id="adminBarcodeLoginBtn">ç®¡ç†å“¡QRcodeç™»é™¸</div>
                </div>
                
                <div id="adminCodeLoginForm">
                    <div class="form-group">
                        <label for="adminId">ç®¡ç†å“¡ç·¨è™Ÿ</label>
                        <input type="text" id="adminId" class="form-control" placeholder="è¼¸å…¥ç®¡ç†å“¡ç·¨è™Ÿ">
                    </div>
                    
                    <div class="form-group">
                        <label for="adminPassword">ç®¡ç†å“¡å¯†ç¢¼</label>
                        <input type="password" id="adminPassword" class="form-control" placeholder="è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼">
                    </div>
                    
                    <button class="btn btn-block" id="adminLoginBtn">ç®¡ç†å“¡ç™»é™¸</button>
                </div>
                
                <div id="adminBarcodeLoginForm" style="display: none;">
                    <div class="barcode-scan" id="adminBarcodeScan">
                        <i class="fas fa-barcode"></i>
                        <p>é»æ“Šæ­¤è™•æƒæQRcode</p>
                        <p class="small">ä¸¦å°‡QRcodeå°æº–æ”åƒé ­</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ç”¨æˆ·ä»ªè¡¨ç›˜ -->
        <div class="dashboard card" id="userDashboard">
            <div class="card-header">
                <i class="fas fa-gift"></i>
                <h2>ç©åˆ†å…Œæ›ä¸­å¿ƒ</h2>
            </div>
            
            <div class="user-info">
                <div>
                    <h3 id="dashboardUserName">å¼ ä¸‰</h3>
                    <p>ç”¨æˆ¶ç·¨è™Ÿ: <span id="dashboardUserId">U1001</span></p>
                    <p>QRcodeç·¨ç¢¼: <span id="dashboardUserBarcode">BARCODE001</span></p>
                    <p>æ®µä½: <span id="dashboardUserTier">é’éŠ…</span></p>
                </div>
                <div>
                    <div class="points" id="dashboardUserPoints">1500</div>
                    <div style="text-align: right;">ç´¯ç©ç©åˆ†: <span id="dashboardUserTotalPoints">2500</span></div>
                </div>
            </div>
            
            <div class="user-barcode">
                <h4>æˆ‘çš„QRcode</h4>
                <div id="userBarcodeDisplay"></div>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="prizes">çå“å…Œæ›</div>
                <div class="tab" data-tab="history">ç©åˆ†æ­·å²</div>
            </div>
            
            <div class="tab-content active" id="prizes-tab">
                <h3 style="margin-bottom: 15px;">å¯ç”¨çå“</h3>
                <div class="prizes-grid" id="prizesGrid">
                    <!-- å¥–å“å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <div class="tab-content" id="history-tab">
                <h3 style="margin-bottom: 15px;">ç©åˆ†æ­·å²ç´€éŒ„</h3>
                <div id="userHistoryContent">
                    <!-- ç”¨æˆ·ç§¯åˆ†å†å²å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <button class="btn btn-block logout-btn" id="userLogoutBtn">é€€å‡ºç™»é™¸</button>
        </div>
        
        <!-- ç®¡ç†å‘˜ä»ªè¡¨ç›˜ -->
        <div class="dashboard card" id="adminDashboard">
            <div class="card-header">
                <i class="fas fa-cogs"></i>
                <h2>ç©åˆ†ç®¡ç†ç³»çµ±</h2>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="users">ç”¨æˆ¶ç®¡ç†</div>
                <div class="tab" data-tab="prizes-admin">çå“ç®¡ç†</div>
                <div class="tab" data-tab="history-admin">ç©åˆ†æ­·å²</div>
                <div class="tab" data-tab="system-admin">ç³»çµ±ç®¡ç†</div>
            </div>
            
            <div class="tab-content active" id="users-tab">
                <div class="user-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label">ç¸½ç”¨æˆ¶æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalPoints">0</div>
                        <div class="stat-label">ç¸½ç©åˆ†</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUsers">0</div>
                        <div class="stat-label">ğŸ‘‘ğŸ‘‘ğŸ‘‘ç‹è€…ç”¨æˆ¶ğŸ…ï¸ğŸ…ï¸ğŸ…ï¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUser4">0</div>
                        <div class="stat-label">ğŸ’é‘½çŸ³ç”¨æˆ¶ğŸ’</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUser3">0</div>
                        <div class="stat-label">ğŸ’é‰‘é‡‘ç”¨æˆ¶ğŸ’</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUser2">0</div>
                        <div class="stat-label">âœ¨é»ƒé‡‘ç”¨æˆ¶âœ¨</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUser1">0</div>
                        <div class="stat-label">ğŸ¥ˆç™½éŠ€ç”¨æˆ¶ğŸ¥ˆ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUser0">0</div>
                        <div class="stat-label">.ğŸ”¥é’éŠ…ç”¨æˆ¶ğŸ”¥.</div>
                    </div>
                </div>
                
                <div class="search-box">
                    <input type="text" id="searchUser" class="form-control" placeholder="è¼¸å…¥ç”¨æˆ¶ç·¨è™ŸÂ·å§“åæˆ–QRcodeç·¨ç¢¼">
                    <button class="btn" id="searchUserBtn">æœç´¢</button>
                    <button class="btn btn-secondary" id="clearSearchBtn">æ¸…é™¤</button>
                </div>
                
                <div class="admin-controls">
                    <div class="form-group">
                        <label for="pointsChange">ç©åˆ†è®Šæ›´</label>
                        <input type="number" id="pointsChange" class="form-control" placeholder="è¼¸å…¥ç©åˆ†è®Šæ›´å€¼">
                    </div>
                    <div class="form-group">
                        <label for="pointsReason">è®Šæ›´åŸå› </label>
                        <select id="pointsReason" class="reason-select">
                            <option value="">-- é¸æ“‡åŸå›  --</option>
                            <option value="ä»»å‹™çå‹µ">ä»»å‹™çå‹µ</option>
                            <option value="æ´»å‹•çå‹µ">æ´»å‹•çå‹µ</option>
                            <option value="æŒ‘æˆ°çå‹µ">æŒ‘æˆ°çå‹µ</option>
                            <option value="é–±è®€çå‹µ">é–±è®€çå‹µ</option>
                            <option value="ç®¡ç†å“¡èª¿æ•´">ç®¡ç†å“¡èª¿æ•´</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                        <input type="text" id="customReason" class="reason-input" placeholder="è¼¸å…¥å…¶ä»–åŸå› " style="display: none;">
                    </div>
                    <button class="btn" id="updatePointsBtn" style="align-self: flex-end;">æ›´æ–°ç©åˆ†</button>
                    <button class="btn btn-success" id="addUserBtn" style="align-self: flex-end;">æ·»åŠ ç”¨æˆ¶</button>
                    <button class="btn btn-info" id="exportUsersBtn" style="align-self: flex-end;">å°å‡ºç”¨æˆ¶</button>
                </div>
                
                <h3>ç”¨æˆ¶åˆ—è¡¨</h3>
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>ç”¨æˆ¶ç·¨è™Ÿ</th>
                            <th>å§“å</th>
                            <th>QRcodeç·¨ç¢¼</th>
                            <th>ç•¶å‰ç©åˆ†</th>
                            <th>ç´¯ç©ç©åˆ†</th>
                            <th>æ®µä½</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- ç”¨æˆ·æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
            
            <div class="tab-content" id="prizes-admin-tab">
                <div class="admin-controls">
                    <div class="form-group">
                        <label for="prizeName">çå“åç¨±</label>
                        <input type="text" id="prizeName" class="form-control" placeholdr="è¼¸å…¥çå“åç¨±e">
                    </div>
                    <div class="form-group">
                        <label for="prizePoints">æ‰€éœ€ç©åˆ†</label>
                        <input type="number" id="prizePoints" class="form-control" placeholder="è¼¸å…¥æ‰€éœ€ç©åˆ†" min="1">
                    </div>
                    <div class="form-group">
                        <label for="prizeIcon">åœ–æ¨™</label>
                        <input type="text" id="prizeIcon" class="form-control" placeholder="è¼¸å…¥FontAwesomeåœ–æ¨™åç¨±" value="fa-gift">
                    </div>
                    <button class="btn btn-success" id="addPrizeBtn" style="align-self: flex-end;">æ·»åŠ çå“</button>
                    <button class="btn btn-info" id="exportPrizesBtn" style="align-self: flex-end;">å°å‡ºçå“</button>
                </div>
                
                <h3>çå“åˆ—è¡¨</h3>
                <table class="prizes-table">
                    <thead>
                        <tr>
                            <th>çå“ID</th>
                            <th>çå“åç¨±</th>
                            <th>æ‰€éœ€ç©åˆ†</th>
                            <th>åœ–æ¨™</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="prizesTableBody">
                        <!-- å¥–å“æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
            
            <div class="tab-content" id="history-admin-tab">
                <div class="search-box">
                    <input type="text" id="searchHistoryUser" class="form-control" placeholder="è¼¸å…¥ç”¨æˆ¶ç·¨è™Ÿã€å§“åæˆ–QRcodeç·¨ç¢¼">
                    <button class="btn" id="searchHistoryBtn">æœç´¢æ­·å²ç´€éŒ„</button>
                    <button class="btn btn-secondary" id="clearHistorySearchBtn">æ¸…é™¤</button>
                </div>
                
                <div class="data-management">
                    <button class="btn btn-info" id="exportHistoryBtn">å°å‡ºæ­·å²ç´€éŒ„</button>
                    <button class="btn btn-warning" id="clearHistoryBtn">æ¸…ç©ºæ­·å²ç´€éŒ„</button>
                </div>
                
                <h3>ç©åˆ†æ­·å²ç´€éŒ„</h3>
                <div id="adminHistoryContent">
                    <!-- ç®¡ç†å‘˜æŸ¥çœ‹çš„ç§¯åˆ†å†å²å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <div class="tab-content" id="system-admin-tab">
                <div class="admin-controls">
                    <div class="form-group">
                        <label for="currentPassword">ç•¶å‰å¯†ç¢¼</label>
                        <input type="password" id="currentPassword" class="form-control" placeholder="è¼¸å…¥ç•¶å‰å¯†ç¢¼">
                    </div>
                    <div class="form-group">
                        <label for="newPassword">æ–°å¯†ç¢¼</label>
                        <input type="password" id="newPassword" class="form-control" placeholder="è¼¸å…¥æ–°å¯†ç¢¼">
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">ç¢ºèªæ–°å¯†ç¢¼</label>
                        <input type="password" id="confirmPassword" class="form-control" placeholder="å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼">
                    </div>
                    <button class="btn btn-warning" id="changePasswordBtn" style="align-self: flex-end;">ä¿®æ”¹å¯†ç¢¼</button>
                </div>
                
                <div class="data-management">
                    <button class="btn btn-info" id="importDataBtn">å°å…¥æ­·å²æ•¸æ“š</button>
                    <button class="btn btn-success" id="exportDataBtn">å°å‡ºæ‰€æœ‰æ•¸æ“š</button>
                    <button class="btn btn-danger" id="resetDataBtn">é‡ç½®æ‰€æœ‰æ•¸æ“š</button>
                </div>
                
                <div class="form-group">
                    <label for="dataFile">é¸æ“‡æ•¸æ“šæ–‡ä»¶ (JSONæ ¼å¼)</label>
                    <input type="file" id="dataFile" class="form-control" accept=".json">
                </div>
                
                <h3>ç³»ç»Ÿä¿¡æ¯</h3>
                <div class="user-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="systemUsers">0</div>
                        <div class="stat-label">ç”¨æˆ¶æ•¸é‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="systemPrizes">0</div>
                        <div class="stat-label">çå“æ•¸é‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="systemHistory">0</div>
                        <div class="stat-label">æ­·å²ç´€éŒ„</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="systemAdmins">0</div>
                        <div class="stat-label">ç®¡ç†å“¡æ•¸é‡</div>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-block logout-btn" id="adminLogoutBtn">é€€å‡ºç™»é™¸</button>
        </div>
    </div>
    
    <!-- æ·»åŠ ç”¨æˆ·æ¨¡æ€æ¡† -->
    <div class="modal" id="addUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ·»åŠ æ–°ç”¨æˆ¶</h3>
                <button class="close-btn" id="closeAddUserModal">&times;</button>
            </div>
            <div class="form-group">
                <label for="newUserName">ç”¨æˆ·å§“å</label>
                <input type="text" id="newUserName" class="form-control" placeholder="è«‹è¼¸å…¥ç”¨æˆ·å§“å">
            </div>
            <div class="form-group">
                <label for="newUserId">ç”¨æˆ·ç·¨è™Ÿ</label>
                <input type="text" id="newUserId" class="form-control" placeholder="è«‹è¼¸å…¥ç”¨æˆ·ç·¨è™Ÿ">
            </div>
            <div class="form-group">
                <label for="newUserPoints">åˆå§‹ç©åˆ†</label>
                <input type="number" id="newUserPoints" class="form-control" value="0" min="0">
            </div>
            <div class="form-group">
                <label>ç”Ÿæˆçš„QRcodeç·¨ç¢¼: <span id="generatedBarcodeCode">BARCODE001</span></label>
            </div>
            <div class="barcode-container" id="newUserBarcode"></div>
            <button class="btn btn-success btn-block" id="confirmAddUser">ç¢ºèªæ·»åŠ ç”¨æˆ·</button>
        </div>
    </div>
    
    <!-- ç¼–è¾‘å¥–å“æ¨¡æ€æ¡† -->
    <div class="modal" id="editPrizeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç·¨è¼¯çå“</h3>
                <button class="close-btn" id="closeEditPrizeModal">&times;</button>
            </div>
            <div class="form-group">
                <label for="editPrizeName">çå“åç¨±</label>
                <input type="text" id="editPrizeName" class="form-control" placeholder="è«‹è¼¸å…¥çå“åç¨±">
            </div>
            <div class="form-group">
                <label for="editPrizePoints">æ‰€éœ€ç©åˆ†</label>
                <input type="number" id="editPrizePoints" class="form-control" placeholder="è«‹è¼¸å…¥æ‰€éœ€ç©åˆ†" min="1">
            </div>
            <div class="form-group">
                <label for="editPrizeIcon">åœ–æ¨™é¡å</label>
                <input type="text" id="editPrizeIcon" class="form-control" placeholder="è¼¸å…¥FontAwesomeåœ–æ¨™é¡å">
            </div>
            <input type="hidden" id="editPrizeId">
            <button class="btn btn-success btn-block" id="confirmEditPrize">ç¡®è®¤ä¿®æ”¹</button>
        </div>
    </div>
    
    <!-- æ¡å½¢ç æ‰«ææ¨¡æ€æ¡† -->
    <div class="modal" id="barcodeScannerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æƒæQRcode</h3>
                <button class="close-btn" id="closeScannerModal">&times;</button>
            </div>
            <div class="scan-area">
                <div id="scanner-container">
                    <!-- æ‘„åƒå¤´é¢„è§ˆå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
                <div class="scan-overlay">
                    <div class="scan-line"></div>
                </div>
            </div>
            <div class="scan-controls">
                <button class="btn" id="startScannerBtn">é–‹å§‹æƒæ</button>
                <button class="btn btn-danger" id="stopScannerBtn" style="display: none;">åœæ­¢æƒæ</button>
            </div>
            <div class="form-group" style="margin-top: 15px;">
                <label>æƒæçµæœ: <span id="scanResult">ç­‰å¾…æƒæ...</span></label>
            </div>
            <button class="btn btn-success btn-block" id="confirmScanBtn" style="display: none;">ç¢ºèªæ­¤QRcodeç·¨ç¢¼æ­£ç¢ºï¼Ÿ</button>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>

    <script>
        // ç”¨æˆ·æ•°æ®å­˜å‚¨
        let users = JSON.parse(localStorage.getItem('barcodePointsUsers')) || [
            { 
                id: 'U1001', 
                name: 'å¼ ä¸‰', 
                barcodeCode: 'USER001', 
                points: 1500, 
                totalPoints: 2500, // æ–°å¢ï¼šç´¯ç©ç©åˆ†
                tier: 'é‰‘é‡‘', // æ–°å¢ï¼šæ®µä½
                isAdmin: false 
            },
            { 
                id: 'U1002', 
                name: 'æå››', 
                barcodeCode: 'USER002', 
                points: 800, 
                totalPoints: 1200, // æ–°å¢ï¼šç´¯ç©ç©åˆ†
                tier: 'é»ƒé‡‘', // æ–°å¢ï¼šæ®µä½
                isAdmin: false 
            },
            { 
                id: 'U1003', 
                name: 'ç‹äº”', 
                barcodeCode: 'USER003', 
                points: 2200, 
                totalPoints: 3200, // æ–°å¢ï¼šç´¯ç©ç©åˆ†
                tier: 'é‘½çŸ³', // æ–°å¢ï¼šæ®µä½
                isAdmin: false 
            },
            { 
                id: 'wwlwcf002', 
                name: 'ç®¡ç†å‘˜', 
                barcodeCode: 'wwlwcf002', 
                points: 0, 
                totalPoints: 0, // æ–°å¢ï¼šç´¯ç©ç©åˆ†
                tier: '', // æ–°å¢ï¼šæ®µä½
                isAdmin: true 
            }
        ];
        
        // å¥–å“æ•°æ®å­˜å‚¨
        let prizes = JSON.parse(localStorage.getItem('barcodePointsPrizes')) || [
            { id: 'P001', name: 'å’–å•¡åˆ¸', points: 200, icon: 'fa-mug-hot' },
            { id: 'P002', name: 'ç”µå½±ç¥¨', points: 500, icon: 'fa-film' },
            { id: 'P003', name: 'è“ç‰™è€³æœº', points: 1500, icon: 'fa-headphones' },
            { id: 'P004', name: 'æ™ºèƒ½æ‰‹è¡¨', points: 3000, icon: 'fa-clock' },
            { id: 'P005', name: 'å¹³æ¿ç”µè„‘', points: 5000, icon: 'fa-tablet-alt' },
            { id: 'P006', name: 'è´­ç‰©å¡', points: 1000, icon: 'fa-shopping-bag' }
        ];
        
        // ç§¯åˆ†å†å²è®°å½•å­˜å‚¨
        let pointsHistory = JSON.parse(localStorage.getItem('barcodePointsHistory')) || [
            { userId: 'U1001', timestamp: new Date('2023-10-01 09:30:00').getTime(), pointsChange: 100, reason: 'ç­¾åˆ°å¥–åŠ±' },
            { userId: 'U1001', timestamp: new Date('2023-10-05 14:20:00').getTime(), pointsChange: -200, reason: 'å…‘æ¢å’–å•¡åˆ¸' },
            { userId: 'U1001', timestamp: new Date('2023-10-10 11:15:00').getTime(), pointsChange: 500, reason: 'æ´»åŠ¨å¥–åŠ±' },
            { userId: 'U1001', timestamp: new Date('2023-10-15 15:40:00').getTime(), pointsChange: 800, reason: 'ç®¡ç†å‘˜è°ƒæ•´' },
            { userId: 'U1002', timestamp: new Date('2023-10-02 10:45:00').getTime(), pointsChange: 100, reason: 'ç­¾åˆ°å¥–åŠ±' },
            { userId: 'U1002', timestamp: new Date('2023-10-07 16:30:00').getTime(), pointsChange: 300, reason: 'å®Œæˆä»»åŠ¡' },
            { userId: 'U1003', timestamp: new Date('2023-10-03 08:20:00').getTime(), pointsChange: 100, reason: 'ç­¾åˆ°å¥–åŠ±' },
            { userId: 'U1003', timestamp: new Date('2023-10-08 13:10:00').getTime(), pointsChange: 1000, reason: 'æ¨èç”¨æˆ·å¥–åŠ±' },
            { userId: 'U1003', timestamp: new Date('2023-10-12 17:25:00').getTime(), pointsChange: 400, reason: 'æ´»åŠ¨å¥–åŠ±' }
        ];
        
        // æ®µä½åˆ’åˆ†æ ‡å‡†ï¼ˆåŸºäºç´¯ç§¯ç§¯åˆ†ï¼‰
        const tierThresholds = [
            { name: 'é’éŠ…', min: 0, max: 299 },
            { name: 'ç™½éŠ€', min: 300, max: 599 },
            { name: 'é»ƒé‡‘', min: 600, max: 899 },
            { name: 'é‰‘é‡‘', min: 900, max: 1199 },
            { name: 'é‘½çŸ³', min: 1200, max: 1499 },
            { name: 'ç‹è€…', min: 1500, max: Infinity }
        ];
        
        // è®¡ç®—ç”¨æˆ·æ®µä½
        function calculateUserTier(totalPoints) {
            for (const tier of tierThresholds) {
                if (totalPoints >= tier.min && totalPoints <= tier.max) {
                    return tier.name;
                }
            }
            return 'é’éŠ…';
        }
        
        // è·å–æ®µä½å¯¹åº”çš„CSSç±»å
        function getTierClass(tierName) {
            switch(tierName) {
                case 'ç‹è€…': return 'tier-king';
                case 'é‘½çŸ³': return 'tier-diamond';
                case 'é‰‘é‡‘': return 'tier-platinum';
                case 'é»ƒé‡‘': return 'tier-gold';
                case 'ç™½éŠ€': return 'tier-silver';
                case 'é’éŠ…': return 'tier-bronze';
                default: return 'tier-bronze';
            }
        }
        
        // *****
        const adminPassword = 'admin123';
        
        // DOMå…ƒç´ 
        const loginSection = document.getElementById('loginSection');
        const userDashboard = document.getElementById('userDashboard');
        const adminDashboard = document.getElementById('adminDashboard');
        const userBarcodeScan = document.getElementById('userBarcodeScan');
        const adminBarcodeScan = document.getElementById('adminBarcodeScan');
        const userLoginBtn = document.getElementById('userLoginBtn');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const userLogoutBtn = document.getElementById('userLogoutBtn');
        const adminLogoutBtn = document.getElementById('adminLogoutBtn');
        const prizesGrid = document.getElementById('prizesGrid');
        const usersTableBody = document.getElementById('usersTableBody');
        const prizesTableBody = document.getElementById('prizesTableBody');
        const updatePointsBtn = document.getElementById('updatePointsBtn');
        const addUserBtn = document.getElementById('addUserBtn');
        const addUserModal = document.getElementById('addUserModal');
        const closeAddUserModal = document.getElementById('closeAddUserModal');
        const confirmAddUser = document.getElementById('confirmAddUser');
        const generatedBarcodeCode = document.getElementById('generatedBarcodeCode');
        const newUserBarcode = document.getElementById('newUserBarcode');
        const addPrizeBtn = document.getElementById('addPrizeBtn');
        const editPrizeModal = document.getElementById('editPrizeModal');
        const closeEditPrizeModal = document.getElementById('closeEditPrizeModal');
        const confirmEditPrize = document.getElementById('confirmEditPrize');
        const searchHistoryBtn = document.getElementById('searchHistoryBtn');
        const barcodeScannerModal = document.getElementById('barcodeScannerModal');
        const closeScannerModal = document.getElementById('closeScannerModal');
        const startScannerBtn = document.getElementById('startScannerBtn');
        const stopScannerBtn = document.getElementById('stopScannerBtn');
        const scanResult = document.getElementById('scanResult');
        const confirmScanBtn = document.getElementById('confirmScanBtn');
        const userIdInput = document.getElementById('userIdInput');
        const userBarcodeDisplay = document.getElementById('userBarcodeDisplay');
        const notification = document.getElementById('notification');
        
        // ç™»å½•é€‰é¡¹åˆ‡æ¢
        const userCodeLoginBtn = document.getElementById('userCodeLoginBtn');
        const userBarcodeLoginBtn = document.getElementById('userBarcodeLoginBtn');
        const userCodeLoginForm = document.getElementById('userCodeLoginForm');
        const userBarcodeLoginForm = document.getElementById('userBarcodeLoginForm');
        
        const adminCodeLoginBtn = document.getElementById('adminCodeLoginBtn');
        const adminBarcodeLoginBtn = document.getElementById('adminBarcodeLoginBtn');
        const adminCodeLoginForm = document.getElementById('adminCodeLoginForm');
        const adminBarcodeLoginForm = document.getElementById('adminBarcodeLoginForm');
        
        // æ–°å¢åŠŸèƒ½å…ƒç´ 
        const searchUserBtn = document.getElementById('searchUserBtn');
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        const exportUsersBtn = document.getElementById('exportUsersBtn');
        const exportPrizesBtn = document.getElementById('exportPrizesBtn');
        const exportHistoryBtn = document.getElementById('exportHistoryBtn');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const clearHistorySearchBtn = document.getElementById('clearHistorySearchBtn');
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        const importDataBtn = document.getElementById('importDataBtn');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const resetDataBtn = document.getElementById('resetDataBtn');
        const dataFile = document.getElementById('dataFile');
        const pointsReason = document.getElementById('pointsReason');
        const customReason = document.getElementById('customReason');
        
        // å½“å‰ç™»å½•çš„ç”¨æˆ·å’Œç®¡ç†å‘˜
        let currentUser = null;
        let currentAdmin = false;
        let scannerActive = false;
        let scannedBarcode = '';
        let scannerType = '';
        
        // ä¿®å¤æ¡å½¢ç ç”Ÿæˆå‡½æ•°
        function generateBarcode(code, container) {
            container.innerHTML = '';
            
            if (!code || code.trim() === '') {
                container.innerHTML = '<div class="barcode-placeholder">æ¡å½¢ç ç¼–ç ä¸ºç©º</div>';
                return;
            }
            
            try {
                // åˆ›å»ºcanvaså…ƒç´ 
                const canvas = document.createElement('canvas');
                container.appendChild(canvas);
                
                // ä½¿ç”¨JsBarcodeç”Ÿæˆæ¡å½¢ç 
                JsBarcode(canvas, code, {
                    format: "CODE128",
                    width: 2,
                    height: 100,
                    displayValue: true,
                    fontOptions: "bold",
                    fontSize: 16,
                    textMargin: 10,
                    margin: 10,
                    background: "#ffffff",
                    lineColor: "#000000"
                });
                
                console.log('QRcodeç”ŸæˆæˆåŠŸ:', code);
            } catch (error) {
                console.error('QRcodeç”Ÿæˆå¤±æ•—:', error);
                container.innerHTML = '<div class="barcode-placeholder">QRcodeç”Ÿæˆå¤±æ•—: ' + error.message + '</div>';
            }
        }

        // åˆå§‹åŒ–é¡µé¢
        function initPage() {
            // ä¿å­˜åˆå§‹æ•°æ®åˆ°localStorage
            saveDataToStorage();
            
            renderPrizes();
            renderUsersTable();
            renderPrizesTable();
            setupTabs();
            setupLoginOptions();
            updateSystemStats();
            
            // ç§¯åˆ†å˜æ›´åŸå› é€‰æ‹©äº‹ä»¶
            pointsReason.addEventListener('change', function() {
                if (this.value === 'å…¶ä»–') {
                    customReason.style.display = 'block';
                } else {
                    customReason.style.display = 'none';
                    customReason.value = '';
                }
            });
            
            // ç”¨æˆ·ç™»å½•æŒ‰é’®äº‹ä»¶
            userLoginBtn.addEventListener('click', function() {
                const userId = userIdInput.value;
                if (userId) {
                    loginWithUserId(userId);
                } else {
                    showNotification('è«‹è¼¸å…¥ç”¨æˆ¶ç·¨è™Ÿ', 'error');
                }
            });
            
            // ç”¨æˆ·æ¡å½¢ç æ‰«æäº‹ä»¶
            userBarcodeScan.addEventListener('click', function() {
                openBarcodeScanner('user');
            });
            
            // ç®¡ç†å‘˜æ¡å½¢ç æ‰«æäº‹ä»¶
            adminBarcodeScan.addEventListener('click', function() {
                openBarcodeScanner('admin');
            });
            
            // ç®¡ç†å‘˜ç™»å½•æŒ‰é’®äº‹ä»¶
            adminLoginBtn.addEventListener('click', function() {
                const adminId = document.getElementById('adminId').value;
                const password = document.getElementById('adminPassword').value;
                
                if (adminId && password) {
                    loginAdminWithCredentials(adminId, password);
                } else {
                    showNotification('è«‹è¼¸å…¥ç®¡ç†å“¡ç·¨è™Ÿå’Œå¯†ç¢¼', 'error');
                }
            });
            
            // ç”¨æˆ·é€€å‡ºç™»å½•
            userLogoutBtn.addEventListener('click', function() {
                currentUser = null;
                showLoginSection();
                showNotification('å·²ç™»å‡ºç”¨æˆ¶ç™»éŒ„', 'info');
            });
            
            // ç®¡ç†å‘˜é€€å‡ºç™»å½•
            adminLogoutBtn.addEventListener('click', function() {
                // è¯¢é—®æ˜¯å¦è¦ä¸‹è½½å¤‡ä»½
                if (confirm('æ˜¯å¦è¦ä¸‹è¼‰æœ€æ–°çš„ç³»çµ±æ–‡ä»¶ï¼Ÿ')) {
                    exportAllData();
                }
                currentAdmin = false;
                document.getElementById('adminId').value = '';
                document.getElementById('adminPassword').value = '';
                showLoginSection();
                showNotification('å·²ç™»å‡ºç®¡ç†å“¡ç™»é™¸', 'info');
            });
            
            // æ›´æ–°ç§¯åˆ†æŒ‰é’®äº‹ä»¶
            updatePointsBtn.addEventListener('click', function() {
                const searchTerm = document.getElementById('searchUser').value;
                const pointsChange = parseInt(document.getElementById('pointsChange').value);
                let reason = pointsReason.value;
                
                if (reason === 'å…¶ä»–') {
                    reason = customReason.value;
                }
                
                if (!searchTerm || isNaN(pointsChange)) {
                    showNotification('è«‹è¼¸å…¥æœ‰æ•ˆçš„è®Šæ›´å€¼å’Œç”¨æˆ¶ç·¨è™Ÿ', 'error');
                    return;
                }
                
                if (!reason) {
                    showNotification('è«‹é¸æ“‡æˆ–è¼¸å…¥è®Šæ›´åŸå› ', 'error');
                    return;
                }
                
                const user = users.find(u => 
                    u.id === searchTerm || 
                    u.name === searchTerm || 
                    u.barcodeCode === searchTerm
                );
                
                if (user) {
                    user.points += pointsChange;
                    if (user.points < 0) user.points = 0;
                    
                    // å¦‚æœæ˜¯å¢åŠ ç§¯åˆ†ï¼ŒåŒæ—¶å¢åŠ ç´¯ç§¯ç§¯åˆ†
                    if (pointsChange > 0) {
                        user.totalPoints += pointsChange;
                    }
                    
                    // æ›´æ–°æ®µä½
                    user.tier = calculateUserTier(user.totalPoints);
                    
                    // è®°å½•ç§¯åˆ†å˜æ›´å†å²
                    pointsHistory.push({
                        userId: user.id,
                        timestamp: new Date().getTime(),
                        pointsChange: pointsChange,
                        reason: reason
                    });
                    
                    // ä¿å­˜æ•°æ®
                    saveDataToStorage();
                    
                    renderUsersTable();
                    updateSystemStats();
                    document.getElementById('pointsChange').value = '';
                    pointsReason.value = '';
                    customReason.value = '';
                    customReason.style.display = 'none';
                    
                    showNotification(`æˆåŠŸæ›´æ–° ${user.name} çš„ç©åˆ†ï¼`, 'success');
                } else {
                    showNotification('æœªæ‰¾åˆ°è©²ç”¨æˆ¶', 'error');
                }
            });
            
            // æ·»åŠ ç”¨æˆ·æŒ‰é’®äº‹ä»¶
            addUserBtn.addEventListener('click', function() {
                // ç”Ÿæˆéšæœºæ¡å½¢ç ç¼–ç 
                const newBarcodeCode = generateBarcodeCode();
                generatedBarcodeCode.textContent = newBarcodeCode;
                
                // ç”Ÿæˆæ¡å½¢ç  - æ·»åŠ å»¶è¿Ÿç¡®ä¿DOMæ›´æ–°
                setTimeout(() => {
                    generateBarcode(newBarcodeCode, newUserBarcode);
                }, 100);
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                addUserModal.style.display = 'flex';
            });
            
            // å…³é—­æ·»åŠ ç”¨æˆ·æ¨¡æ€æ¡†
            closeAddUserModal.addEventListener('click', function() {
                addUserModal.style.display = 'none';
            });
            
            // ç¡®è®¤æ·»åŠ ç”¨æˆ·
            confirmAddUser.addEventListener('click', function() {
                const userName = document.getElementById('newUserName').value;
                const userId = document.getElementById('newUserId').value;
                const userPoints = parseInt(document.getElementById('newUserPoints').value) || 0;
                const barcodeCode = generatedBarcodeCode.textContent;
                
                if (!userName || !userId) {
                    showNotification('è«‹è¼¸å…¥ç”¨æˆ¶å§“åæˆ–ç·¨è™Ÿ', 'error');
                    return;
                }
                
                // æ£€æŸ¥ç”¨æˆ·ç¼–å·æ˜¯å¦å·²å­˜åœ¨
                if (users.find(u => u.id === userId)) {
                    showNotification('ç”¨æˆ¶ç·¨è™Ÿå·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨å…¶ä»–ç·¨è™Ÿ', 'error');
                    return;
                }
                
                // è®¡ç®—æ®µä½
                const userTier = calculateUserTier(userPoints);
                
                // æ·»åŠ æ–°ç”¨æˆ·
                users.push({
                    id: userId,
                    name: userName,
                    barcodeCode: barcodeCode,
                    points: userPoints,
                    totalPoints: userPoints, // åˆå§‹ç´¯ç§¯ç§¯åˆ†ç­‰äºå½“å‰ç§¯åˆ†
                    tier: userTier, // åˆå§‹æ®µä½
                    isAdmin: false
                });
                
                // è®°å½•åˆå§‹ç§¯åˆ†å†å²
                if (userPoints > 0) {
                    pointsHistory.push({
                        userId: userId,
                        timestamp: new Date().getTime(),
                        pointsChange: userPoints,
                        reason: 'åˆå§‹ç©åˆ†'
                    });
                }
                
                // ä¿å­˜æ•°æ®
                saveDataToStorage();
                
                // æ›´æ–°ç•Œé¢
                renderUsersTable();
                updateSystemStats();
                
                // å…³é—­æ¨¡æ€æ¡†å¹¶é‡ç½®è¡¨å•
                addUserModal.style.display = 'none';
                document.getElementById('newUserName').value = '';
                document.getElementById('newUserId').value = '';
                document.getElementById('newUserPoints').value = '0';
                
                showNotification(`æˆåŠŸæ·»åŠ ç”¨æˆ· ${userName}ï¼Œæ¡å½¢ç ç¼–ç : ${barcodeCode}`, 'success');
            });
            
            // æ·»åŠ å¥–å“æŒ‰é’®äº‹ä»¶
            addPrizeBtn.addEventListener('click', function() {
                const prizeName = document.getElementById('prizeName').value;
                const prizePoints = parseInt(document.getElementById('prizePoints').value);
                const prizeIcon = document.getElementById('prizeIcon').value;
                
                if (!prizeName || isNaN(prizePoints) || prizePoints < 1) {
                    showNotification('è«‹è¼¸å…¥æœ‰æ•ˆçš„çå“ä¿¡æ¯', 'error');
                    return;
                }
                
                // ç”Ÿæˆå¥–å“ID
                const prizeId = generatePrizeId();
                
                // æ·»åŠ æ–°å¥–å“
                prizes.push({
                    id: prizeId,
                    name: prizeName,
                    points: prizePoints,
                    icon: prizeIcon
                });
                
                // ä¿å­˜æ•°æ®
                saveDataToStorage();
                
                // æ›´æ–°ç•Œé¢
                renderPrizesTable();
                renderPrizes();
                updateSystemStats();
                
                // é‡ç½®è¡¨å•
                document.getElementById('prizeName').value = '';
                document.getElementById('prizePoints').value = '';
                document.getElementById('prizeIcon').value = 'fa-gift';
                
                showNotification(`æˆåŠŸæ·»åŠ çå“ ${prizeName}`, 'success');
            });
            
            // å…³é—­ç¼–è¾‘å¥–å“æ¨¡æ€æ¡†
            closeEditPrizeModal.addEventListener('click', function() {
                editPrizeModal.style.display = 'none';
            });
            
            // ç¡®è®¤ç¼–è¾‘å¥–å“
            confirmEditPrize.addEventListener('click', function() {
                const prizeId = document.getElementById('editPrizeId').value;
                const prizeName = document.getElementById('editPrizeName').value;
                const prizePoints = parseInt(document.getElementById('editPrizePoints').value);
                const prizeIcon = document.getElementById('editPrizeIcon').value;
                
                if (!prizeName || isNaN(prizePoints) || prizePoints < 1) {
                    showNotification('è«‹è¼¸å…¥æœ‰æ•ˆçš„å¥–å“ä¿¡æ¯', 'error');
                    return;
                }
                
                // æ›´æ–°å¥–å“ä¿¡æ¯
                const prize = prizes.find(p => p.id === prizeId);
                if (prize) {
                    prize.name = prizeName;
                    prize.points = prizePoints;
                    prize.icon = prizeIcon;
                    
                    // ä¿å­˜æ•°æ®
                    saveDataToStorage();
                    
                    // æ›´æ–°ç•Œé¢
                    renderPrizesTable();
                    renderPrizes();
                    
                    // å…³é—­æ¨¡æ€æ¡†
                    editPrizeModal.style.display = 'none';
                    
                    showNotification(`æˆåŠŸæ›´æ–°çå“ ${prizeName}`, 'success');
                }
            });
            
            // æœç´¢å†å²è®°å½•æŒ‰é’®äº‹ä»¶
            searchHistoryBtn.addEventListener('click', function() {
                const searchTerm = document.getElementById('searchHistoryUser').value;
                renderAdminHistory(searchTerm);
            });
            
            // æ¡å½¢ç æ‰«ææ¨¡æ€æ¡†äº‹ä»¶
            closeScannerModal.addEventListener('click', function() {
                closeBarcodeScanner();
            });
            
            startScannerBtn.addEventListener('click', function() {
                startBarcodeScanner();
            });
            
            stopScannerBtn.addEventListener('click', function() {
                stopBarcodeScanner();
            });
            
            confirmScanBtn.addEventListener('click', function() {
                if (scannedBarcode) {
                    if (scannerType === 'user') {
                        loginWithBarcode(scannedBarcode);
                    } else if (scannerType === 'admin') {
                        loginAdminWithBarcode(scannedBarcode);
                    }
                    closeBarcodeScanner();
                }
            });
            
            // æ–°å¢åŠŸèƒ½äº‹ä»¶
            searchUserBtn.addEventListener('click', function() {
                const searchTerm = document.getElementById('searchUser').value;
                renderUsersTable(searchTerm);
            });
            
            clearSearchBtn.addEventListener('click', function() {
                document.getElementById('searchUser').value = '';
                renderUsersTable();
            });
            
            exportUsersBtn.addEventListener('click', function() {
                exportUsersData();
            });
            
            exportPrizesBtn.addEventListener('click', function() {
                exportPrizesData();
            });
            
            exportHistoryBtn.addEventListener('click', function() {
                exportHistoryData();
            });
            
            clearHistoryBtn.addEventListener('click', function() {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç©åˆ†æ­·å²ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ï¼')) {
                    pointsHistory = [];
                    saveDataToStorage();
                    renderAdminHistory();
                    updateSystemStats();
                    showNotification('æ­·å²ç´€éŒ„å·²æ¸…ç©º', 'success');
                }
            });
            
            clearHistorySearchBtn.addEventListener('click', function() {
                document.getElementById('searchHistoryUser').value = '';
                renderAdminHistory();
            });
            
            changePasswordBtn.addEventListener('click', function() {
                changeAdminPassword();
            });
            
            importDataBtn.addEventListener('click', function() {
                dataFile.click();
            });
            
            exportDataBtn.addEventListener('click', function() {
                exportAllData();
            });
            
            resetDataBtn.addEventListener('click', function() {
                resetSystemData();
            });
            
            dataFile.addEventListener('change', function(e) {
                importData(e);
            });
        }
        
        // è®¾ç½®ç™»å½•é€‰é¡¹åˆ‡æ¢
        function setupLoginOptions() {
            // ç”¨æˆ·ç™»å½•é€‰é¡¹
            userCodeLoginBtn.addEventListener('click', function() {
                userCodeLoginBtn.classList.add('active');
                userBarcodeLoginBtn.classList.remove('active');
                userCodeLoginForm.style.display = 'block';
                userBarcodeLoginForm.style.display = 'none';
            });
            
            userBarcodeLoginBtn.addEventListener('click', function() {
                userBarcodeLoginBtn.classList.add('active');
                userCodeLoginBtn.classList.remove('active');
                userCodeLoginForm.style.display = 'none';
                userBarcodeLoginForm.style.display = 'block';
            });
            
            // ç®¡ç†å‘˜ç™»å½•é€‰é¡¹
            adminCodeLoginBtn.addEventListener('click', function() {
                adminCodeLoginBtn.classList.add('active');
                adminBarcodeLoginBtn.classList.remove('active');
                adminCodeLoginForm.style.display = 'block';
                adminBarcodeLoginForm.style.display = 'none';
            });
            
            adminBarcodeLoginBtn.addEventListener('click', function() {
                adminBarcodeLoginBtn.classList.add('active');
                adminCodeLoginBtn.classList.remove('active');
                adminCodeLoginForm.style.display = 'none';
                adminBarcodeLoginForm.style.display = 'block';
            });
        }
        
        // è®¾ç½®é€‰é¡¹å¡åˆ‡æ¢
        function setupTabs() {
            // ç”¨æˆ·ç•Œé¢é€‰é¡¹å¡
            const userTabs = document.querySelectorAll('#userDashboard .tab');
            userTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // ç§»é™¤æ‰€æœ‰activeç±»
                    userTabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('#userDashboard .tab-content').forEach(c => c.classList.remove('active'));
                    
                    // æ·»åŠ activeç±»åˆ°å½“å‰é€‰é¡¹å¡
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // å¦‚æœåˆ‡æ¢åˆ°å†å²è®°å½•é€‰é¡¹å¡ï¼Œæ¸²æŸ“å†å²è®°å½•
                    if (tabId === 'history') {
                        renderUserHistory();
                    }
                });
            });
            
            // ç®¡ç†å‘˜ç•Œé¢é€‰é¡¹å¡
            const adminTabs = document.querySelectorAll('#adminDashboard .tab');
            adminTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // ç§»é™¤æ‰€æœ‰activeç±»
                    adminTabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('#adminDashboard .tab-content').forEach(c => c.classList.remove('active'));
                    
                    // æ·»åŠ activeç±»åˆ°å½“å‰é€‰é¡¹å¡
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // å¦‚æœåˆ‡æ¢åˆ°å†å²è®°å½•é€‰é¡¹å¡ï¼Œæ¸²æŸ“å†å²è®°å½•
                    if (tabId === 'history-admin') {
                        renderAdminHistory();
                    } else if (tabId === 'system-admin') {
                        updateSystemStats();
                    }
                });
            });
        }
        
        // ä½¿ç”¨ç”¨æˆ·ç¼–å·ç™»å½•
        function loginWithUserId(userId) {
            const user = users.find(u => u.id === userId && !u.isAdmin);
            if (user) {
                currentUser = user;
                showUserDashboard();
                showNotification(`ç”¨æˆ· ${user.name} ç™»éŒ„æˆåŠŸï¼`, 'success');
            } else {
                showNotification('ç”¨æˆ·ç·¨è™ŸéŒ¯èª¤æˆ–ä¸æ˜¯æ™®é€šç”¨æˆ·', 'error');
            }
        }
        
        // ä½¿ç”¨æ¡å½¢ç ç™»å½•
        function loginWithBarcode(barcode) {
            const user = users.find(u => u.barcodeCode === barcode && !u.isAdmin);
            if (user) {
                currentUser = user;
                showUserDashboard();
                showNotification(`ç”¨æˆ· ${user.name} ç™»éŒ„æˆåŠŸï¼`, 'success');
            } else {
                showNotification('QRcodeéŒ¯èª¤æˆ–ä¸æ˜¯æ™®é€šç”¨æˆ·', 'error');
            }
        }
        
        // ä½¿ç”¨ç®¡ç†å‘˜å‡­æ®ç™»å½•
        function loginAdminWithCredentials(adminId, password) {
            if (password === adminPassword) {
                const adminUser = users.find(u => u.id === adminId && u.isAdmin);
                if (adminUser) {
                    currentAdmin = true;
                    showAdminDashboard();
                    showNotification('ç®¡ç†å“¡ç™»é™¸æˆåŠŸï¼', 'success');
                } else {
                    showNotification('ç®¡ç†å“¡ç·¨è™ŸéŒ¯èª¤ï¼', 'error');
                }
            } else {
                showNotification('å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦ï¼', 'error');
            }
        }
        
        // ä½¿ç”¨ç®¡ç†å‘˜æ¡å½¢ç ç™»å½•
        function loginAdminWithBarcode(barcode) {
            const adminUser = users.find(u => u.barcodeCode === barcode && u.isAdmin);
            if (adminUser) {
                currentAdmin = true;
                showAdminDashboard();
                showNotification('ç®¡ç†å“¡ç™»éŒ„æˆåŠŸï¼', 'success');
            } else {
                showNotification('ç®¡ç†å“¡QRcodeéŒ¯èª¤ï¼', 'error');
            }
        }
        
        // æ‰“å¼€æ¡å½¢ç æ‰«æå™¨
        function openBarcodeScanner(type) {
            scannerType = type;
            barcodeScannerModal.style.display = 'flex';
            scanResult.textContent = 'ç­‰å¾…æƒæ...';
            confirmScanBtn.style.display = 'none';
            scannedBarcode = '';
        }
        
        // å…³é—­æ¡å½¢ç æ‰«æå™¨
        function closeBarcodeScanner() {
            barcodeScannerModal.style.display = 'none';
            stopBarcodeScanner();
        }
        
        // å¼€å§‹æ¡å½¢ç æ‰«æ
        function startBarcodeScanner() {
            if (scannerActive) return;
            
            const scannerContainer = document.getElementById('scanner-container');
            scannerContainer.innerHTML = '';
            
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: scannerContainer,
                    constraints: {
                        width: 480,
                        height: 320,
                        facingMode: "environment" // ä½¿ç”¨åç½®æ”åƒé ­
                    }
                },
                decoder: {
                    readers: ["code_128_reader", "ean_reader", "upc_reader"]
                }
            }, function(err) {
                if (err) {
                    console.error(err);
                    showNotification('ç„¡æ³•å•Ÿå‹•æ”åƒé ­: ' + err, 'error');
                    return;
                }
                Quagga.start();
                scannerActive = true;
                startScannerBtn.style.display = 'none';
                stopScannerBtn.style.display = 'inline-block';
            });
            
            Quagga.onDetected(function(result) {
                if (result && result.codeResult) {
                    scannedBarcode = result.codeResult.code;
                    scanResult.textContent = scannedBarcode;
                    confirmScanBtn.style.display = 'block';
                    showNotification('ç›£æ¸¬åˆ°QRcode: ' + scannedBarcode, 'success');
                    
                    // è‡ªåŠ¨åœæ­¢æ‰«æ
                    stopBarcodeScanner();
                }
            });
        }
        
        // åœæ­¢æ¡å½¢ç æ‰«æ
        function stopBarcodeScanner() {
            if (scannerActive) {
                Quagga.stop();
                scannerActive = false;
                startScannerBtn.style.display = 'inline-block';
                stopScannerBtn.style.display = 'none';
            }
        }
        
        // æ˜¾ç¤ºç™»å½•åŒºåŸŸ
        function showLoginSection() {
            loginSection.style.display = 'flex';
            userDashboard.style.display = 'none';
            adminDashboard.style.display = 'none';
            userIdInput.value = '';
        }
        
        // æ˜¾ç¤ºç”¨æˆ·ä»ªè¡¨ç›˜
        function showUserDashboard() {
            loginSection.style.display = 'none';
            userDashboard.style.display = 'block';
            adminDashboard.style.display = 'none';
            
            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
            document.getElementById('dashboardUserName').textContent = currentUser.name;
            document.getElementById('dashboardUserId').textContent = currentUser.id;
            document.getElementById('dashboardUserBarcode').textContent = currentUser.barcodeCode;
            document.getElementById('dashboardUserPoints').textContent = currentUser.points;
            document.getElementById('dashboardUserTotalPoints').textContent = currentUser.totalPoints;
            document.getElementById('dashboardUserTier').textContent = currentUser.tier;
            document.getElementById('dashboardUserTier').className = 'user-tier ' + getTierClass(currentUser.tier);
            
            // ç”Ÿæˆç”¨æˆ·æ¡å½¢ç  - æ·»åŠ å»¶è¿Ÿ
            setTimeout(() => {
                generateBarcode(currentUser.barcodeCode, userBarcodeDisplay);
            }, 100);
            
            // é‡æ–°æ¸²æŸ“å¥–å“åˆ—è¡¨
            renderPrizes();
        }
        
        // æ˜¾ç¤ºç®¡ç†å‘˜ä»ªè¡¨ç›˜
        function showAdminDashboard() {
            loginSection.style.display = 'none';
            userDashboard.style.display = 'none';
            adminDashboard.style.display = 'block';
        }
        
        // æ¸²æŸ“å¥–å“åˆ—è¡¨ï¼ˆç”¨æˆ·ç•Œé¢ï¼‰
        function renderPrizes() {
            prizesGrid.innerHTML = '';
            
            prizes.forEach(prize => {
                const prizeCard = document.createElement('div');
                prizeCard.className = 'prize-card';
                
                const canAfford = currentUser && currentUser.points >= prize.points;
                
                prizeCard.innerHTML = `
                    <div class="prize-image">
                        <i class="fas ${prize.icon}"></i>
                    </div>
                    <div class="prize-name">${prize.name}</div>
                    <div class="prize-points">${prize.points} ç§¯åˆ†</div>
                    <button class="btn ${canAfford ? '' : 'disabled'}" 
                            ${canAfford ? '' : 'disabled'}
                            onclick="redeemPrize('${prize.id}')">
                        ${canAfford ? 'ç«‹å³å…Œæ›' : 'ç©åˆ†ä¸è¶³'}
                    </button>
                `;
                
                prizesGrid.appendChild(prizeCard);
            });
        }
        
        // å…‘æ¢å¥–å“
        function redeemPrize(prizeId) {
            const prize = prizes.find(p => p.id === prizeId);
            
            if (currentUser.points >= prize.points) {
                currentUser.points -= prize.points;
                
                // è®°å½•ç§¯åˆ†å˜æ›´å†å²
                pointsHistory.push({
                    userId: currentUser.id,
                    timestamp: new Date().getTime(),
                    pointsChange: -prize.points,
                    reason: `å…Œæ›çå“ï¼š${prize.name}`
                });
                
                // ä¿å­˜æ•°æ®
                saveDataToStorage();
                
                document.getElementById('dashboardUserPoints').textContent = currentUser.points;
                renderPrizes();
                showNotification(`æˆåŠŸå…‘æ¢ ${prize.name}ï¼`, 'success');
            } else {
                showNotification('ç©åˆ†ä¸è¶³ï¼Œæ— æ³•å…‘æ¢è©²çå“', 'error');
            }
        }
        
        // æ¸²æŸ“ç”¨æˆ·è¡¨æ ¼
        function renderUsersTable(searchTerm = '') {
            usersTableBody.innerHTML = '';
            
            let filteredUsers = users;
            
            if (searchTerm) {
                filteredUsers = users.filter(user => 
                    user.id.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    user.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    user.barcodeCode.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }
            
            filteredUsers.forEach(user => {
                const row = document.createElement('tr');
                const tierClass = getTierClass(user.tier);
                
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.barcodeCode}</td>
                    <td>${user.points}</td>
                    <td>${user.totalPoints}</td>
                    <td><span class="user-tier ${tierClass}">${user.tier}</span></td>
                    <td>
                        <button class="action-btn" style="background: #3498db;" onclick="selectUser('${user.id}')">é€‰æ‹©</button>
                        ${!user.isAdmin ? 
                            `<button class="action-btn" style="background: #f39c12;" onclick="promoteUser('${user.id}')">å‡çº§ä¸ºç®¡ç†å“¡</button>` : 
                            ''
                        }
                        <button class="action-btn" style="background: #e74c3c;" onclick="deleteUser('${user.id}')">ç§»é™¤äººå“¡</button>
                    </td>
                `;
                
                usersTableBody.appendChild(row);
            });
            
            updateUserStats();
        }
        
        // æ¸²æŸ“å¥–å“è¡¨æ ¼ï¼ˆç®¡ç†å‘˜ç•Œé¢ï¼‰
        function renderPrizesTable() {
            prizesTableBody.innerHTML = '';
            
            prizes.forEach(prize => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${prize.id}</td>
                    <td>${prize.name}</td>
                    <td>${prize.points}</td>
                    <td><i class="fas ${prize.icon}"></i> ${prize.icon}</td>
                    <td>
                        <button class="action-btn" style="background: #3498db;" onclick="editPrize('${prize.id}')">ç¼–è¾‘</button>
                        <button class="action-btn" style="background: #e74c3c;" onclick="deletePrize('${prize.id}')">ç§»é™¤äººå“¡</button>
                    </td>
                `;
                
                prizesTableBody.appendChild(row);
            });
        }
        
        // æ¸²æŸ“ç”¨æˆ·ç§¯åˆ†å†å²
        function renderUserHistory() {
            const userHistoryContent = document.getElementById('userHistoryContent');
            userHistoryContent.innerHTML = '';
            
            // è·å–å½“å‰ç”¨æˆ·çš„å†å²è®°å½•
            const userHistory = pointsHistory
                .filter(record => record.userId === currentUser.id)
                .sort((a, b) => b.timestamp - a.timestamp);
            
            if (userHistory.length === 0) {
                userHistoryContent.innerHTML = '<p>æš‚ç„¡ç©åˆ†æ­·å²ç´€éŒ„</p>';
                return;
            }
            
            userHistory.forEach(record => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const pointsClass = record.pointsChange >= 0 ? 'points-positive' : 'points-negative';
                const pointsPrefix = record.pointsChange >= 0 ? '+' : '';
                
                historyItem.innerHTML = `
                    <div>
                        <div>${record.reason}</div>
                        <div class="small">${formatDate(record.timestamp)}</div>
                    </div>
                    <div class="history-points ${pointsClass}">${pointsPrefix}${record.pointsChange}</div>
                `;
                
                userHistoryContent.appendChild(historyItem);
            });
        }
        
        // æ¸²æŸ“ç®¡ç†å‘˜æŸ¥çœ‹çš„ç§¯åˆ†å†å²
        function renderAdminHistory(searchTerm = '') {
            const adminHistoryContent = document.getElementById('adminHistoryContent');
            adminHistoryContent.innerHTML = '';
            
            let filteredHistory = pointsHistory;
            
            // å¦‚æœæä¾›äº†æœç´¢æ¡ä»¶ï¼Œè¿‡æ»¤å†å²è®°å½•
            if (searchTerm) {
                // æŸ¥æ‰¾åŒ¹é…çš„ç”¨æˆ·
                const matchedUsers = users.filter(u => 
                    u.id.includes(searchTerm) || 
                    u.name.includes(searchTerm) || 
                    u.barcodeCode.includes(searchTerm)
                );
                
                const matchedUserIds = matchedUsers.map(u => u.id);
                filteredHistory = pointsHistory.filter(record => 
                    matchedUserIds.includes(record.userId)
                );
            }
            
            // æŒ‰æ—¶é—´æ’åº
            filteredHistory.sort((a, b) => b.timestamp - a.timestamp);
            
            if (filteredHistory.length === 0) {
                adminHistoryContent.innerHTML = '<p>æš‚ç„¡ç©åˆ†æ­·å²ç´€éŒ„</p>';
                return;
            }
            
            filteredHistory.forEach(record => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const user = users.find(u => u.id === record.userId);
                const pointsClass = record.pointsChange >= 0 ? 'points-positive' : 'points-negative';
                const pointsPrefix = record.pointsChange >= 0 ? '+' : '';
                
                historyItem.innerHTML = `
                    <div>
                        <div><strong>${user ? user.name : 'æœªçŸ¥ç”¨æˆ·'} (${record.userId})</strong></div>
                        <div>${record.reason}</div>
                        <div class="small">${formatDate(record.timestamp)}</div>
                    </div>
                    <div class="history-points ${pointsClass}">${pointsPrefix}${record.pointsChange}</div>
                `;
                
                adminHistoryContent.appendChild(historyItem);
            });
        }
        
        // é€‰æ‹©ç”¨æˆ·
        function selectUser(userId) {
            const user = users.find(u => u.id === userId);
            document.getElementById('searchUser').value = user.id;
        }
        
        // å‡çº§ç”¨æˆ·ä¸ºç®¡ç†å‘˜
        function promoteUser(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                user.isAdmin = true;
                
                // ä¿å­˜æ•°æ®
                saveDataToStorage();
                
                renderUsersTable();
                updateSystemStats();
                showNotification(`å·²å°† ${user.name} å‡ç´šç‚ºç®¡ç†å“¡`, 'success');
            }
        }
        
        // åˆ é™¤ç”¨æˆ·
        function deleteUser(userId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤éŠ·ã€‚')) {
                users = users.filter(u => u.id !== userId);
                
                // ä¿å­˜æ•°æ®
                saveDataToStorage();
                
                renderUsersTable();
                updateSystemStats();
                showNotification('ç”¨æˆ·å·²åˆ é™¤', 'success');
            }
        }
        
        // ç¼–è¾‘å¥–å“
        function editPrize(prizeId) {
            const prize = prizes.find(p => p.id === prizeId);
            if (prize) {
                document.getElementById('editPrizeId').value = prize.id;
                document.getElementById('editPrizeName').value = prize.name;
                document.getElementById('editPrizePoints').value = prize.points;
                document.getElementById('editPrizeIcon').value = prize.icon;
                
                editPrizeModal.style.display = 'flex';
            }
        }
        
        // åˆ é™¤å¥–å“
        function deletePrize(prizeId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªçå“å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤éŠ·ã€‚')) {
                prizes = prizes.filter(p => p.id !== prizeId);
                
                // ä¿å­˜æ•°æ®
                saveDataToStorage();
                
                renderPrizesTable();
                renderPrizes();
                updateSystemStats();
                showNotification('çå“å·²åˆ é™¤', 'success');
            }
        }
        
        // æ›´æ–°ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯ - ä½¿ç”¨ç´¯ç§¯ç§¯åˆ†
        function updateUserStats() {
            const totalUsers = users.filter(u => !u.isAdmin).length;
            const totalPoints = users.filter(u => !u.isAdmin).reduce((sum, user) => sum + user.points, 0);
            
            // ä½¿ç”¨ç´¯ç§¯ç§¯åˆ†ç»Ÿè®¡å„æ®µä½ç”¨æˆ·æ•°é‡
            const activeUsers = users.filter(u => !u.isAdmin && u.totalPoints >= 1500).length;
            const activeUser4 = users.filter(u => !u.isAdmin && u.totalPoints >= 1200 && u.totalPoints < 1500).length;
            const activeUser3 = users.filter(u => !u.isAdmin && u.totalPoints >= 900 && u.totalPoints < 1200).length;
            const activeUser2 = users.filter(u => !u.isAdmin && u.totalPoints >= 600 && u.totalPoints < 900).length;
            const activeUser1 = users.filter(u => !u.isAdmin && u.totalPoints >= 300 && u.totalPoints < 600).length;
            const activeUser0 = users.filter(u => !u.isAdmin && u.totalPoints < 300).length;
            
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('totalPoints').textContent = totalPoints;
            document.getElementById('activeUsers').textContent = activeUsers;
            document.getElementById('activeUser4').textContent = activeUser4;
            document.getElementById('activeUser3').textContent = activeUser3;
            document.getElementById('activeUser2').textContent = activeUser2;
            document.getElementById('activeUser1').textContent = activeUser1;
            document.getElementById('activeUser0').textContent = activeUser0;
        }
        
        // æ›´æ–°ç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯
        function updateSystemStats() {
            document.getElementById('systemUsers').textContent = users.filter(u => !u.isAdmin).length;
            document.getElementById('systemPrizes').textContent = prizes.length;
            document.getElementById('systemHistory').textContent = pointsHistory.length;
            document.getElementById('systemAdmins').textContent = users.filter(u => u.isAdmin).length;
            
            updateUserStats();
        }
        
        // å¯¼å‡ºç”¨æˆ·æ•°æ®
        function exportUsersData() {
            const dataStr = JSON.stringify(users.filter(u => !u.isAdmin), null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'users_data.json';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('ç”¨æˆ·æ•¸æ“šå°å‡ºæˆåŠŸ', 'success');
        }
        
        // å¯¼å‡ºå¥–å“æ•°æ®
        function exportPrizesData() {
            const dataStr = JSON.stringify(prizes, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'prizes_data.json';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('çå“æ•¸æ“šå°å‡ºæˆåŠŸ', 'success');
        }
        
        // å¯¼å‡ºå†å²æ•°æ®
        function exportHistoryData() {
            const dataStr = JSON.stringify(pointsHistory, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'history_data.json';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('æ­·å²æ•¸æ“šå°å‡ºæˆåŠŸ', 'success');
        }
        
        // å¯¼å‡ºæ‰€æœ‰æ•°æ®
        function exportAllData() {
            const allData = {
                users: users,
                prizes: prizes,
                history: pointsHistory,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'barcode_system_backup.json';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('ç³»çµ±æ•¸æ“šå‚™ä»½æˆåŠŸ', 'success');
        }
        
        // å¯¼å…¥æ•°æ®
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (importedData.users && Array.isArray(importedData.users)) {
                        users = importedData.users;
                        
                        // ç¡®ä¿å¯¼å…¥çš„ç”¨æˆ·æ•°æ®æœ‰ç´¯ç§¯ç§¯åˆ†å’Œæ®µä½å­—æ®µ
                        users.forEach(user => {
                            if (user.totalPoints === undefined) {
                                user.totalPoints = user.points || 0;
                            }
                            if (user.tier === undefined) {
                                user.tier = calculateUserTier(user.totalPoints);
                            }
                        });
                    }
                    
                    if (importedData.prizes && Array.isArray(importedData.prizes)) {
                        prizes = importedData.prizes;
                    }
                    
                    if (importedData.history && Array.isArray(importedData.history)) {
                        pointsHistory = importedData.history;
                    }
                    
                    saveDataToStorage();
                    renderUsersTable();
                    renderPrizesTable();
                    renderPrizes();
                    updateSystemStats();
                    
                    showNotification('æ•¸æ“šå°å…¥æˆåŠŸ', 'success');
                } catch (error) {
                    showNotification('æ•¸æ“šå°å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼éŒ¯èª¤', 'error');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
            
            // é‡ç½®æ–‡ä»¶è¾“å…¥
            event.target.value = '';
        }
        
        // ä¿®æ”¹ç®¡ç†å‘˜å¯†ç 
        function changeAdminPassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showNotification('è«‹å¡«å¯«æ‰€æœ‰å¯†ç¢¼å­—æ®µ', 'error');
                return;
            }
            
            if (currentPassword !== adminPassword) {
                showNotification('ç•¶å‰å¯†ç¢¼éŒ¯èª¤', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showNotification('æ–°å¯†ç¢¼å’Œç¡®è®¤å¯†ç¢¼ä¸åŒ¹é…', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showNotification('æ–°å¯†ç é•¿åº¦è‡³å°‘6ä½', 'error');
                return;
            }
            
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥å°†æ–°å¯†ç ä¿å­˜åˆ°å®‰å…¨çš„åœ°æ–¹
            // ç”±äºè¿™æ˜¯å‰ç«¯æ¼”ç¤ºï¼Œæˆ‘ä»¬æ— æ³•çœŸæ­£ä¿®æ”¹ç¡¬ç¼–ç çš„å¯†ç 
            // ä½†å¯ä»¥ä¿å­˜åˆ°localStorageä½œä¸ºæ¼”ç¤º
            localStorage.setItem('adminNewPassword', newPassword);
            
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            
            showNotification('å¯†ç ä¿®æ”¹éœ€åˆ°ä»£ç¢¼å±¤å°‹æ‰¾*****', 'success');
        }
        
        // é‡ç½®ç³»ç»Ÿæ•°æ®
        function resetSystemData() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰ç³»çµ±æ•¸æ“šå—ï¼Ÿæ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰ç”¨æˆ·ã€çå“å’Œæ­·å²ç´€éŒ„ï¼Œä¸”ä¸å¯æ¢å¤ï¼')) {
                users = [
                    { 
                        id: 'wwlwcf002', 
                        name: 'ç®¡ç†å‘˜', 
                        barcodeCode: 'wwlwcf002', 
                        points: 0, 
                        totalPoints: 0,
                        tier: '',
                        isAdmin: true 
                    }
                ];
                prizes = [];
                pointsHistory = [];
                
                saveDataToStorage();
                renderUsersTable();
                renderPrizesTable();
                renderPrizes();
                updateSystemStats();
                
                showNotification('ç³»çµ±æ•¸æ“šå·²é‡ç½®', 'success');
            }
        }
        
        // ç”Ÿæˆéšæœºç”¨æˆ·ID
        function generateUserId() {
            const prefix = 'U';
            const timestamp = new Date().getTime().toString().slice(-4);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}${timestamp}${random}`;
        }
        
        // ç”Ÿæˆéšæœºæ¡å½¢ç ç¼–ç 
        function generateBarcodeCode() {
            const prefix = 'USER';
            const timestamp = new Date().getTime().toString().slice(-6);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}${timestamp}${random}`;
        }
        
        // ç”Ÿæˆéšæœºå¥–å“ID
        function generatePrizeId() {
            const prefix = 'P';
            const timestamp = new Date().getTime().toString().slice(-4);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}${timestamp}${random}`;
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(timestamp) {
            const d = new Date(timestamp);
            return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
        }
        
        // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        function saveDataToStorage() {
            localStorage.setItem('barcodePointsUsers', JSON.stringify(users));
            localStorage.setItem('barcodePointsPrizes', JSON.stringify(prizes));
            localStorage.setItem('barcodePointsHistory', JSON.stringify(pointsHistory));
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type) {
            notification.textContent = message;
            notification.style.display = 'block';
            
            if (type === 'success') {
                notification.style.background = '#2ecc71';
            } else if (type === 'error') {
                notification.style.background = '#e74c3c';
            } else {
                notification.style.background = '#3498db';
            }
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // ç¡®ä¿JsBarcodeåº“å·²åŠ è½½
        function checkBarcodeLibrary() {
            if (typeof JsBarcode === 'undefined') {
                console.error('JsBarcodeåº“æœªæ­£ç¡®åŠ è½½');
                // å°è¯•é‡æ–°åŠ è½½
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js';
                script.onload = function() {
                    console.log('JsBarcodeåº“é‡æ–°åŠ è½½æˆåŠŸ');
                    initPage();
                };
                document.head.appendChild(script);
            } else {
                console.log('JsBarcodeåº“å·²åŠ è½½');
                initPage();
            }
        }

        // åœ¨é¡µé¢åŠ è½½æ—¶æ£€æŸ¥
        window.addEventListener('load', function() {
            checkBarcodeLibrary();
        });
    </script>
</body>
</html>